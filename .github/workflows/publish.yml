name: Build Grouped ZIPs (Single Branch)

on:
  workflow_dispatch:

env:
  JSON_CONFIG: "files.json"
  OUTPUT_DIR: "public"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create ZIPs and Index
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}
          
          # HTML Header vorbereiten
          cat > ${{ env.OUTPUT_DIR }}/index.html <<'EOF'
          <!doctype html>
          <html lang="de">
          <head>
            <meta charset="utf-8">
            <title>Download Center</title>
            <style>
              body { font-family: -apple-system, sans-serif; padding: 40px; background: #f8f9fa; color: #212529; }
              .container { max-width: 900px; margin: auto; }
              .project-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 30px; border: 1px solid #dee2e6; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
              h2 { color: #007bff; margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
              ul { list-style: none; padding: 0; }
              li { margin: 12px 0; padding: 12px; background: #f1f3f5; border-radius: 6px; display: flex; align-items: center; }
              .file-name { flex-grow: 1; font-weight: 500; }
              .btn-download { background: #007bff; color: white; text-decoration: none; padding: 6px 15px; border-radius: 4px; font-size: 0.9em; }
              .btn-download:hover { background: #0056b3; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Script Download Portal</h1>
          EOF

          # Projekte aus JSON lesen
          PROJEKT_ANZAHL=$(jq '.projekte | length' ${{ env.JSON_CONFIG }})

          for (( i=0; i<$PROJEKT_ANZAHL; i++ )); do
            PROJEKT_NAME=$(jq -r ".projekte[$i].name" ${{ env.JSON_CONFIG }})
            echo "Verarbeite Projekt: $PROJEKT_NAME"
            
            # Projekt-Sektion im HTML
            echo "<div class='project-card'><h2>$PROJEKT_NAME</h2><ul>" >> ${{ env.OUTPUT_DIR }}/index.html
            
            # Dateien des Projekts auslesen
            FILES=$(jq -r ".projekte[$i].files[]" ${{ env.JSON_CONFIG }})
            
            for file_path in $FILES; do
              if [ -f "$file_path" ]; then
                # Dateiname ohne Pfad und Endung fuer das ZIP
                raw_name=$(basename "$file_path")
                zip_name="${raw_name%.sh}.zip"
                
                # ZIP erstellen (flach)
                zip -j "${{ env.OUTPUT_DIR }}/$zip_name" "$file_path"
                
                echo "<li><span class='file-name'>$raw_name</span><a href='$zip_name' class='btn-download'>Download ZIP</a></li>" >> ${{ env.OUTPUT_DIR }}/index.html
                echo "Erfolg: $zip_name erstellt."
              else
                echo "Warnung: Datei $file_path wurde nicht gefunden."
                echo "<li><span class='file-name' style='color:red;'>$file_path (Nicht gefunden)</span></li>" >> ${{ env.OUTPUT_DIR }}/index.html
              fi
            done
            
            echo "</ul></div>" >> ${{ env.OUTPUT_DIR }}/index.html
          done

          echo "</div></body></html>" >> ${{ env.OUTPUT_DIR }}/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.OUTPUT_DIR }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
